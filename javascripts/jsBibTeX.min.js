function in_array(a,b){for(var c in b)if(b[c]==a)return!0;return!1}function explode(a,b,c){var d={0:""};if(arguments.length<2||"undefined"==typeof arguments[0]||"undefined"==typeof arguments[1])return null;if(""===a||a===!1||null===a)return!1;if("function"==typeof a||"object"==typeof a||"function"==typeof b||"object"==typeof b)return d;if(a===!0&&(a="1"),c){var e=b.toString().split(a.toString()),f=e.splice(0,c-1),g=e.join(a.toString());return f.push(g),f}return b.toString().split(a.toString())}function str_replace(a,b,c){for(var d=a,e=b,f=c,g=e instanceof Array,h=f instanceof Array,d=[].concat(d),e=[].concat(e),i=(f=[].concat(f)).length;j=0,i--;)for(;f[i]=f[i].split(d[j]).join(g?e[j]||"":e[0]),++j in d;);return h?f:f[0]}function strrpos(a,b,c){var d=a.lastIndexOf(b,c);return d>=0?d:!1}function substr(a,b,c){return 0>b&&(b+=a.length),void 0==c?c=a.length:c+=0>c?a.length:b,b>c&&(c=b),a.substring(b,c)}function array_unique(a){var b,c,d,e=a;for(c=e.length;c;)for(b=--c;b>0;)if(e[c]===e[--b]){for(d=b;--b&&e[c]===e[b];);c-=e.splice(b+1,d-b).length}return e}function BibTeX(a){"undefined"==typeof a&&(a={}),this._delimiters={'"':'"',"{":"}"},this.data=[],this.content="",this.warnings=[],this._options={stripDelimiter:!0,validate:!0,unwrap:!1,wordWrapWidth:!1,wordWrapBreak:"\n",wordWrapCut:0,removeCurlyBraces:!1,extractAuthors:!0};for(option in a)test=this.setOption(option,a[option]),this.isError(test);this.rtfstring='AUTHORS, "{\b TITLE}", {i JOURNAL}, YEAR',this.htmlstring='AUTHORS, "<strong>TITLE</strong>", <em>JOURNAL</em>, YEAR<br />',this.allowedEntryTypes=["article","book","booklet","confernce","inbook","incollection","inproceedings","manual","masterthesis","misc","phdthesis","proceedings","techreport","unpublished"],this.authorstring="VON LAST, JR, FIRST"}var php={};php.array_key_exists=function(a,b){return!b||b.constructor!==Array&&b.constructor!==Object?!1:a in b},php.array_keys=function(a,b,c){var d=new Array,c=!!c,e=!0,f=0;for(key in a)e=!0,void 0!=b&&(c&&a[key]!==b?e=!1:a[key]!=b&&(e=!1)),e&&(d[f]=key,f++);return d},php.wordwrap=function(a,b,c,d){var h,i,j,k,l,e=b,f=c,g=d;if(1>e)return a;for(h=-1,j=(l=a.split("\n")).length;++h<j;l[h]+=k)for(k=l[h],l[h]="";k.length>e;l[h]+=k.slice(0,i)+((k=k.slice(i)).length?f:""))i=2==g||(i=k.slice(0,e+1).match(/\S*(\s)?$/))[1]?e:i.input.length-i[0].length||1==g&&e||i.input.length+(i=k.slice(e).match(/^\S*/)).input.length;return l.join("\n")},BibTeX.prototype={setOption:function(a,b){return ret=!0,php.array_key_exists(a,this._options)?this._options[a]=b:ret=this.raiseError("Unknown option "+a),ret},parse:function(a){a&&(this.content=a),this.warnings=[],this.data=[];for(var b=!0,c=0,d=!1,e="",f="",g="",h=0;h<this.content.length;h++){if(e=substr(this.content,h,1),0!=c&&"@"==e&&(this._checkAt(g)||(this._generateWarning("WARNING_MISSING_END_BRACE","",g),e="}",h--)),0==c&&"@"==e)d=!0;else if(d&&"{"==e&&"\\"!=f)c++;else if(d&&"}"==e&&"\\"!=f&&(c--,0>c&&(b=!1),0==c)){d=!1;var i=this._parseEntry(g);i&&(this.data[this.data.length]=i),g=""}d&&(g+=e),f=e}if(1==c&&(i=this._parseEntry(g),i?(this.data[this.data.length]=i,g="",c=0):b=!1),0!=c&&(b=!1),this._options.validate){cites=[];for(var h=0;h<this.data.length;h++)cites[cites.length]=this.data[h].cite;if(unique=array_unique(cites),cites.length!=unique.length){notuniques=[];for(var h=0;h<cites.length;h++)""==unique[h]&&(notuniques[notuniques.length]=cites[h]);this._generateWarning("WARNING_MULTIPLE_ENTRIES",notuniques.join(","))}}return b?(this.content="",this.data):this.raiseError("Unbalanced parenthesis")},_parseEntry:function(a){var b="";this._options.validate&&(b=a);var c={};if("@string"==substr(a,0,7).toLowerCase())this._options.validate&&this._generateWarning("STRING_ENTRY_NOT_YET_SUPPORTED","",a+"}");else if("@preamble"==substr(a,0,9).toLowerCase())this._options.validate&&this._generateWarning("PREAMBLE_ENTRY_NOT_YET_SUPPORTED","",a+"}");else{for(;strrpos(a,"=")!==!1;){for(position=strrpos(a,"="),proceed=!0,"\\"==substr(a,position-1,1)&&(proceed=!1),proceed&&(proceed=this._checkEqualSign(a,position));!proceed;)substring=substr(a,0,position),position=strrpos(substring,"="),proceed=!0,"\\"==substr(a,position-1,1)&&(proceed=!1),proceed&&(proceed=this._checkEqualSign(a,position));value=substr(a,position+1).trim(),a=substr(a,0,position),","==substr(value,value.length-1,1)&&(value=substr(value,0,-1)),this._options.validate&&this._validateValue(value,b),this._options.stripDelimiter&&(value=this._stripDelimiter(value)),this._options.unwrap&&(value=this._unwrap(value)),this._options.removeCurlyBraces&&(value=this._removeCurlyBraces(value)),position=strrpos(a,","),field=substr(a,position+1).trim().toLowerCase(),c[field]=value,a=substr(a,0,position)}var d=explode("{",a);c.cite=d[1].trim(),c.entryType=d[0].trim().toLowerCase(),"@"==c.entryType.substring(0,1)&&(c.entryType=substr(c.entryType,1)),this._options.validate&&(this._checkAllowedEntryType(c.entryType)||this._generateWarning("WARNING_NOT_ALLOWED_ENTRY_TYPE",c.entryType,a+"}")),in_array("author",php.array_keys(c))&&this._options.extractAuthors&&(c.author=this._extractAuthors(c.author))}return c},_checkEqualSign:function(a,b){for(var c=!0,d=0,e=a.length-1;e>=b;e--)precedingchar=substr(a,e-1,1),charv=substr(a,e,1),"{"==charv&&"\\"!=precedingchar&&d++,"}"==charv&&"\\"!=precedingchar&&d--;if(0!=d&&(c=!1),c&&(entrycopy=a.trim(),lastchar=substr(entrycopy,entrycopy.length-1,1),","==lastchar&&(lastchar=substr(entrycopy,entrycopy.length-2,1)),'"'==lastchar)){c=!1,found=0;for(var e=a.length;e>=b;e--)if(precedingchar=substr(a,e-1,1),charv=substr(a,e,1),'"'==charv&&"\\"!=precedingchar&&found++,2==found){c=!0;break}}return c},_checkAllowedEntryType:function(a){return in_array(a,this.allowedEntryTypes)},_checkAt:function(a){var b=!1,c=php.array_keys(this._delimiters),d=array_values(this._delimiters);if(strrpos(a,"=")!==!1){for(position=strrpos(a,"="),proceed=!0,"\\"==substr(a,position-1,1)&&(proceed=!1);!proceed;)substring=substr(a,0,position),position=strrpos(substring,"="),proceed=!0,"\\"==substr(a,position-1,1)&&(proceed=!1);value=substr(a,position+1).trim(),open=0,charv="",lastchar="";for(var e=0;e<value.length;e++)charv=substr(this.content,e,1),in_array(charv,c)&&"\\"!=lastchar?open++:in_array(charv,d)&&"\\"!=lastchar&&open--,lastchar=charv;open>0&&(b=!0)}return b},_stripDelimiter:function(a){for(var b=php.array_keys(this._delimiters),c=substr(a,0,1),d=substr(a,-1,1);in_array(c,b)&&d==this._delimiters[c];)a=substr(a,1,-1),c=substr(a,0,1),d=substr(a,-1,1);return a},_unwrap:function(a){return a.replace(/\s+/," ").trim()},_wordwrap:function(a){return""!=a&&"string"==typeof a&&(a=php.wordwrap(a,this._options.wordWrapWidth,this._options.wordWrapBreak,this._options.wordWrapCut)),a},_extractAuthors:function(a){a=this._unwrap(a);var b=[];b=explode(" and ",a);for(var c=0;c<b.length;c++){var d=b[c].trim(),e="",f="",g="",h="";if(-1===d.indexOf(",")){var i=[];i=explode(" |~",d);var j=i.length;if(1==j)g=i[0];else if(2==j)e=i[0],g=i[1];else{for(var k=!1,l=!1,m=0;j-1>m;m++)if(l)g+=" "+i[m];else if(k)if(o=this._determineCase(i[m]),this.isError(o));else if(0==o||-1==o){islast=!0;for(var n=m+1;j-1>n;n++)futurecase=this._determineCase(i[n]),this.isError(o)||0==futurecase&&(islast=!1);islast?(l=!0,-1==o?g+=" "+i[m]:f+=" "+i[m]):f+=" "+i[m]}else f+=" "+i[m];else{var o=this._determineCase(i[m]);this.isError(o)||(0==o?(k=!0,f+=" "+i[m]):e+=" "+i[m])}g+=" "+i[j-1]}}else{var i=[];if(i=explode(",",d),vonlastarray=[],vonlastarray=explode(" ",i[0]),j=vonlastarray.length,1==j)g=vonlastarray[0];else{l=!1;for(var m=0;j-1>m;m++)if(l)g+=" "+vonlastarray[m];else if(0!=this._determineCase(vonlastarray[m])){islast=!0;for(var n=m+1;j-1>n;n++)this._determineCase(vonlastarray[n]),o=this._determineCase(vonlastarray[n]),this.isError(o)||0==o&&(islast=!1);islast?(l=!0,g+=" "+vonlastarray[m]):f+=" "+vonlastarray[m]}else f+=" "+vonlastarray[m];g+=" "+vonlastarray[j-1]}3==i.length&&(h=i[1]),e=i[i.length-1]}b[c]={first:e.trim(),von:f.trim(),last:g.trim(),jr:h.trim()}}return b},_determineCase:function(a){var b=-1,c=a.trim();if("string"==typeof a&&c.length>0)for(var d=0,e=!1,f=0;!e&&d<=a.length;){var g=substr(c,d,1),h=g.charCodeAt(0);123==h&&f++,125==h&&f--,h>=65&&90>=h&&0==f?(b=1,e=!0):h>=97&&122>=h&&0==f?(b=0,e=!0):d++}else b=this.raiseError("Could not determine case on word: "+a);return b},isError:function(a){return"Object"==typeof a&&1==a.isError},_validateValue:function(a,b){a.match(/^{.*@.*}/)&&this._generateWarning("WARNING_AT_IN_BRACES",a,b),a.match(/^\".*\\".*\"/)&&this._generateWarning("WARNING_ESCAPED_DOUBLE_QUOTE_INSIDE_DOUBLE_QUOTES",a,b);for(var c=0,d="",e="",f=0;f<a.length;f++)e=substr(a,f,1),"{"==e&&"\\"!=d&&c++,"}"==e&&"\\"!=d&&c--,d=e;0!=c&&this._generateWarning("WARNING_UNBALANCED_AMOUNT_OF_BRACES",a,b)},_removeCurlyBraces:function(a){for(var b=php.array_keys(this._delimiters),c=substr(a,0,1),d=substr(a,-1,1),e="",f="";in_array(c,b)&&d==this._delimiters[c];)e+=c,f+=d,a=substr(a,1,-1),c=substr(a,0,1),d=substr(a,-1,1);var h="12";return a=a.replace(/([^\\\\])\{(.*?[^\\\\])\}/,h),a=e+a+f},_generateWarning:function(a,b,c){var d={};"undefined"==typeof c&&(c=""),d.warning=a,d.entry=b,d.wholeentry=c,this.warnings[this.warnings.length]=d},clearWarnings:function(){this.warnings=[]},hasWarning:function(){return this.warnings.length>0},amount:function(){return this.data.length},_formatAuthor:function(a){return a.von=php.array_key_exists("von",a)?a.von.trim():"",a.last=php.array_key_exists("last",a)?a.last.trim():"",a.jr=php.array_key_exists("jr",a)?a.jr.trim():"",a.first=php.array_key_exists("first",a)?a.first.trim():"",ret=this.authorstring,ret=str_replace("VON",a.von,ret),ret=str_replace("LAST",a.last,ret),ret=str_replace("JR",a.jr,ret),ret=str_replace("FIRST",a.first,ret),ret.trim()},bibTex:function(){for(var a="",b=0;b<this.data.length;b++){var c=this.data[b];a+="@"+c.entryType.toLowerCase()+" { "+c.cite+",\n";for(key in c){var d=c[key];this._options.wordWrapWidth>0&&(d=this._wordWrap(d)),in_array(key,["cite","entryType","author"])||(a+="	"+key+" = {"+d+"},\n")}if(php.array_key_exists("author",c))if(this._options.extractAuthors){tmparray=[];for(j in c.author){var e=c.author[j];tmparray[tmparray.length]=this._formatAuthor(e)}author=tmparray.join(" and ")}else author=c.author;else author="";a+="	author = {"+author+"}\n",a+="}\n\n"}return a},addEntry:function(a){this.data[this.data.length]=a},getStatistic:function(){for(var a=[],b=0;b<this.data.length;b++){var c=this.data[b];php.array_key_exists(c.entryType,a)?a[c.entryType]++:a[c.entryType]=1}return a},rtf:function(){for(var a="{\\rtf\n",b=0;b<this.data.length;b++){var c=this.data[b];if(line=this.rtfstring,title="",journal="",year="",authors="",php.array_key_exists("title",c)&&(title=this._unwrap(c.title)),php.array_key_exists("journal",c)&&(journal=this._unwrap(c.journal)),php.array_key_exists("year",c)&&(year=this._unwrap(c.year)),php.array_key_exists("author",c))if(this._options.extractAuthors){tmparray=[];for(var d in c.author){var e=c.author[d];tmparray[tmparray.length]=this._formatAuthor(e)}authors=tmparray.join(", ")}else authors=c.author;""!=title||""!=journal||""!=year||""!=authors?(line=str_replace("TITLE",title,line),line=str_replace("JOURNAL",journal,line),line=str_replace("YEAR",year,line),line=str_replace("AUTHORS",authors,line),line+="\n\\par\n",a+=line):this._generateWarning("WARNING_LINE_WAS_NOT_CONVERTED","",JSON.stringify(c))}return a+="}"},html:function(a,b){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=this.data.length);for(var c="<p>\n",d=a;b>d;d++){var e=this.data[d],f=this.htmlstring,g="",h="",i="",k="";if(php.array_key_exists("title",e)&&(g=this._unwrap(e.title)),php.array_key_exists("journal",e)&&(h=this._unwrap(e.journal)),php.array_key_exists("year",e)&&(i=this._unwrap(e.year)),php.array_key_exists("author",e))if(this._options.extractAuthors){tmparray=[];for(j in e.author){var l=e.author[j];tmparray[tmparray.length]=this._formatAuthor(l)}k=tmparray.join(", ")}else k=e.author;""!=g||""!=h||""!=i||""!=k?(f=str_replace("TITLE",g,f),f=str_replace("JOURNAL",h,f),f=str_replace("YEAR",i,f),f=str_replace("AUTHORS",k,f),f+="\n",c+=f):this._generateWarning("WARNING_LINE_WAS_NOT_CONVERTED","",JSON.stringify(e))}return c+="</p>\n"}},jsBibTeX=new BibTeX;